---
title: "SEIR3 example"
author: "Aaron A. King"
output:
  html_document:
    toc: yes
    toc_depth: 4
bibliography: ../sbied.bib
csl: ../ecology.csl
---

\newcommand\prob[1]{\mathbb{P}\left[{#1}\right]}
\newcommand\expect[1]{\mathbb{E}\left[{#1}\right]}
\newcommand\var[1]{\mathrm{Var}\left[{#1}\right]}
\newcommand\dist[2]{\mathrm{#1}\left(#2\right)}
\newcommand\dlta[1]{{\Delta}{#1}}
\newcommand\lik{\mathcal{L}}
\newcommand\loglik{\ell}

[Licensed under the Creative Commons Attribution-NonCommercial license](http://creativecommons.org/licenses/by-nc/4.0/).
Please share and remix noncommercially, mentioning its origin.  
![CC-BY_NC](../graphics/cc-by-nc.png)

```{r knitr-opts,include=FALSE,purl=FALSE}
library(knitr)
prefix <- "seir3"
opts_chunk$set(
  progress=TRUE,
  prompt=FALSE,tidy=FALSE,highlight=TRUE,
  strip.white=TRUE,
  warning=FALSE,
  message=FALSE,
  error=FALSE,
  echo=TRUE,
  cache=TRUE,
  cache.extra=rand_seed,
  results='markup',
  fig.show='asis',
  size='small',
  fig.lp="fig:",
  fig.path=paste0("figure/",prefix,"-"),
  cache.path=paste0("cache/",prefix,"-"),
  fig.pos="h!",
  fig.align='center',
  fig.height=4,fig.width=6.83,
  dpi=100,
  dev='png',
  dev.args=list(bg='transparent')
)
options(keep.source=TRUE,encoding="UTF-8")
```
```{r prelims,include=FALSE,purl=TRUE,cache=FALSE}
library(pomp)
stopifnot(packageVersion("pomp")>="1.6")
library(ggplot2)
theme_set(theme_bw())
library(plyr)
library(reshape2)
library(magrittr)
options(stringsAsFactors=FALSE)
set.seed(1221234211)
```

----------------------------

Formulate a model with a latent class and both confinement and convalescent stages.
Implement it in **pomp** using a compartmental model like that diagrammed below.
You will have to give some thought to just how to model the relationship between the data ($B$ and $C$) and the state variables.

```{r seir3_model}
read.table("http://kingaa.github.io/sbied/stochsim/bsflu_data.txt") -> bsflu

rproc <- Csnippet("
  double N = 763;
  double t1 = rbinom(S,1-exp(-Beta*I/N*dt));
  double t2 = rbinom(E,1-exp(-mu_E*dt));
  double t3 = rbinom(I,1-exp(-mu_I*dt));
  double t4 = rbinom(R1,1-exp(-mu_R1*dt));
  double t5 = rbinom(R2,1-exp(-mu_R2*dt));
  S  -= t1;
  E  += t1 - t2;
  I  += t2 - t3;
  R1 += t3 - t4;
  R2 += t4 - t5;
")

init <- Csnippet("
  S  = 762;
  E  = 0;
  I  = 1;
  R1 = 0;
  R2 = 0;
")

dmeas <- Csnippet("
  lik = dpois(B,rho*R1+1e-6,give_log);
")

rmeas <- Csnippet("
  B = rpois(rho*R1+1e-6);
")

bsflu %>%
    subset(select=-C) %>%
    pomp(times="day",t0=-6,
         rprocess=euler.sim(rproc,delta.t=1/5),
         initializer=init,rmeasure=rmeas,dmeasure=dmeas,
         statenames=c("S","E","I","R1","R2"),
         paramnames=c("Beta","mu_E","mu_I","mu_R1","mu_R2","rho")
         ) -> flu
```

How many parameters can reasonably be fixed?
How many must be estimated?
Obtain some ballpark estimates of the parameters and simulate to see if you can plausibly explain the data as a realization of this model.


```{r simulations}
coef(flu) <- c(Beta=6,mu_E=0.5,mu_I=2,mu_R1=0.2,mu_R2=0.5,rho=0.9)

flu %>%
    simulate(nsim=20,as.data.frame=TRUE,include.data=TRUE) %>%
    subset(select=c(time,B,sim)) %>%
    ggplot(aes(x=time,y=B,color=(sim=="data"),group=sim))+
    geom_line()+
    guides(color=FALSE)

```

```{r}
fixed_params <- with(bsflu,c(mu_R1=1/(sum(B)/512),mu_R2=1/(sum(C)/512)))
```

----------------------------

## [Back to course homepage](http://kingaa.github.io/sbied)
## [**R** codes for this document](http://raw.githubusercontent.com/kingaa/sbied/master/seir3/seir3.R)

----------------------------

## References
